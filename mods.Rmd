---
title: "GAM evaluation - SF Bay"
output: 
  html_document:
    code_folding: hide
    css: kable.css
self_contained: yes
runtime: shiny
---

```{r, message = F, warning = F, results = 'hide'}
# globals
library(knitr)
opts_chunk$set(warning = FALSE, message = FALSE, dev.args = list(bg = 'transparent'), eval = T)

library(tidyverse)
library(lubridate)
library(mgcv)
library(shiny)

source('R/funcs.R')

data(datprc)
data(modssta)
data(sta32)
```

## Exploratory plots

```{r}
# create plots for whole time series, by year, by month
# all variables, stations
rawplo <- datprc %>% 
  group_by(param) %>% 
  nest %>% 
  mutate(
    tot = map(data, function(x){
      
      p <- ggplot(x, aes(x = dec_time, y = value)) + 
        geom_line() +
        theme_bw(base_family = 'serif') +
        facet_wrap(~ station, ncol = 2) +
        theme(strip.background = element_blank())
      
      return(p)
      
    }),
    yrs = map(data, function(x){
      
      p <- ggplot(x, aes(x = factor(yr), y = value)) + 
        geom_boxplot(base_family = 'serif') +
        theme_bw(base_family = 'serif') +
        scale_x_discrete("Year") +
        facet_wrap(~ station, ncol = 2) +
        theme(strip.background = element_blank())
      
      return(p)
      
    }), 
    mos = map(data, function(x){
      
      p <- ggplot(x, aes(x = mo, y = value)) + 
        geom_boxplot() +
        theme_bw() +
        facet_wrap(~ station, ncol = 2) +
        theme(strip.background = element_blank())
      
      return(p)
      
    })
  )
```

Plots for raw data, all stations and parameters, 1990 - 2017.  Select the parameter, plot type (total time series, by year, or by month), and variable transformation.
```{r, echo = F}
# selection widgets
selectInput("prm", "Choose parameter:", unique(datprc$param))
selectInput("typ", "Choose plot type:", c('tot', 'yrs', 'mos'))
selectInput("log", "Log-space:", c(T, F))

# get the plot
toplo <- reactive({

  sel <- filter(rawplo, param %in% input$prm) %>% 
    select(matches(input$typ)) %>% 
    .[[1]] %>% 
    .[[1]]
  
  if(input$log){
  
    sel <- sel + scale_y_log10(input$prm)
    
  } else {
    
    sel <- sel + scale_y_continuous(input$prm)
    
  }
  
  return(sel)
  
})

# make the plot
renderPlot({
  
  toplo()
  
}, height = 800, width = 900)

```

## GAMs of log-chlorophyll with annual, seasonal trends

```{r}
# get GAMs for each station, simple models with different combos of dec_time, doy

# smooths to evaluate
smths <- c(
  "s(dec_time, bs = 'tp')",  
  "s(doy, bs = 'cc')",
  "te(dec_time, doy, bs = c('tp', 'cc'))"
)

# get all combinations of smoothers to model, one to many
frms <- list()
for(i in seq_along(smths)){
  
 frm <- combn(smths, i) %>%
    apply(2, function(x){
      paste(x, collapse = ' + ') %>% 
        paste('log10(chl) ~ ', .) %>% 
        formula
    }) 
  
 frms <- c(frms, frm)
 
}

# enframe frms for combine with tomod
frms <- frms %>% 
  enframe('modi', 'frm')

# data to model, same as datprc, params in wide format, nested by station
# crossed with frms
tomod <- datprc %>% 
  spread(param, value) %>% 
  group_by(station) %>% 
  nest %>% 
  crossing(frms)

# # create models for every station, gam model eval
# modssta <- tomod %>% 
#   mutate(
#     modv = pmap(list(data, frm), function(data, frm){
#   
#       gam(frm, 
#         knots = list(doy = c(1, 366)),
#         data = data, 
#         na.action = na.exclude
#       )
# 
#   })
#   )
# save(modssta, file = 'data/modssta.RData', compress = 'xz')
```

Select station for summary of all seven GAM chlorophyll models:
```{r, echo = F}
# selection widgets
selectInput("sta", "Choose station:", unique(datprc$station))

mods <- reactive({
  modssta %>% filter(station %in% input$sta)
})

# smoother stats of GAMs
renderTable({
  map(mods()$modv, ~ summary(.x)$s.table %>% data.frame %>% rownames_to_column('smoother')) %>% 
    enframe %>% 
    unnest
})

# summary stats of GAMs, model fit/perf
renderTable({
  map(mods()$modv, ~ data.frame(
      AIC = AIC(.x), 
      GCV = .x$gcv.ubre,
      R2 = summary(.x)$r.sq)) %>% 
    enframe %>% 
    unnest
})
```

```{r}
# prediction data
prdplo <- reactive({
    
  prdplo <- mods() %>%
    mutate(prddat = pmap(list(data, modv), function(data, modv){
  
  
      prddat <- data.frame(
          dec_time = seq(min(data$dec_time), max(data$dec_time), length = 1000)
        ) %>%
        mutate(
          date = date_decimal(dec_time),
          date = as.Date(date),
          mo = month(date, label = TRUE),
          doy = yday(date),
          yr = year(date)
        )
  
      prd <- predict(modv, newdata = prddat)
      
      prddat <- prddat %>% mutate(chl = prd)
  
      return(prddat)
      
    })) %>% 
    select(modi, prddat) %>% 
    unnest
  
})

rawchl <- reactive({
  rawchl <- mods()$data[[1]]
})

# facet by mod, doy x axis, lines by year
renderPlot({
  p <- ggplot(prdplo(), aes(x = doy, group = factor(yr), colour = yr)) + 
    geom_line(aes(y = chl)) + 
    theme_bw(base_family = 'serif', base_size = 16) + 
    theme(
      legend.position = 'top', 
      legend.title = element_blank()
      ) + 
    scale_y_continuous('log10(chl)') +
    facet_wrap(~ modi, ncol = 2) +
    guides(colour = guide_colourbar(barheight = 1, barwidth = 20)) + 
    ggtitle(paste0('Station', input$sta))
  p
}, height = 900, width = 900)

# plot predictions, all mods, by time
renderPlot({
  # plot
  p <- ggplot(prdplo(), aes(x = date)) + 
    geom_point(data = rawchl(), aes(y = log10(chl)), size = 0.5) +
    geom_line(aes(y = chl, colour = factor(modi))) + 
    theme_bw(base_family = 'serif', base_size = 16) + 
    theme(
      legend.position = 'top', 
      legend.title = element_blank()
      ) + 
    ggtitle(paste0('Station', input$sta))
  p
})
```

Individual model:
```{r, echo = F}
selectInput('mod', "Select a model:", unique(modssta$modi))
```
```{r}
# smoother stats of GAMs
renderTable({
  
  md <- mods() %>% 
    filter(modi %in% input$mod) %>% 
    .$modv %>% 
    .[[1]]
  tab <- summary(md)$s.table %>% data.frame %>% rownames_to_column('smoother')
  return(tab)

})

# summary stats of GAMs, model fit/perf
renderTable({
  
  md <- mods() %>% 
    filter(modi %in% input$mod) %>% 
    .$modv %>% 
    .[[1]] 
  tab <- data.frame(
    AIC = AIC(md), 
    GCV = md$gcv.ubre,
    R2 = summary(md)$r.sq)
  return(tab)
  
})
renderPlot({
  
  toplo <- prdplo() %>% 
    filter(modi %in% input$mod)
  
  # plot
  p <- ggplot(toplo, aes(x = date)) + 
    geom_point(data = rawchl(), aes(y = log10(chl)), size = 0.5) +
    geom_line(aes(y = chl)) + 
    theme_bw(base_family = 'serif', base_size = 16) + 
    theme(
      legend.position = 'top', 
      legend.title = element_blank()
      ) + 
    ggtitle(paste0('Station', input$sta))
  p
})
```

## GAMs of log-chlorophyll with annual, seasonal, salinity trends, station 32 only

```{r}
# # get GAMs for each station, simple models with different combos of dec_time, doy
# 
# # smooths to evaluate
# smths <- c(
#   "s(dec_time, bs = 'tp')",  
#   "s(doy, bs = 'cc')",
#   "s(sal, bs = 'tp')",
#   "te(sal, doy, bs = c('tp', 'cc'))", 
#   "te(sal, dec_time, bs = c('tp', 'tp'))",
#   "te(dec_time, doy, bs = c('tp', 'cc'))",
#   "te(dec_time, doy, sal, bs = c('tp', 'cc', 'tp'))"
# )
# 
# # get all combinations of smoothers to model, one to many
# frms <- list()
# for(i in seq_along(smths)){
#   
#  frm <- combn(smths, i) %>%
#     apply(2, function(x){
#       paste(x, collapse = ' + ') %>% 
#         paste('log10(chl) ~ ', .) %>% 
#         formula
#     }) 
#   
#  frms <- c(frms, frm)
#  
# }
# 
# # enframe frms for combine with tomod
# frms <- frms %>% 
#   enframe('modi', 'frm')
# 
# # data to model, same as datprc, params in wide format, nested by station
# # crossed with frms
# tomod <- datprc %>% 
#   spread(param, value) %>% 
#   group_by(station) %>% 
#   nest %>% 
#   crossing(frms)
# 
# # create models for every station, gam model eval
# modsstacv <- tomod %>% 
#   mutate(
#     modv = pmap(list(data, frm), function(data, frm){
#   
#       gam(frm, 
#         knots = list(doy = c(1, 366)),
#         data = data, 
#         na.action = na.exclude
#       )
# 
#   })
#   )
# sta32 <- modsstacv %>% filter(station %in% 32)
# save(sta32, file = 'data/sta32.RData', compress = 'xz')
```

Summary of all model combinations at station 32:
```{r, echo = F, eval = T}

modonest <- sta32

# smoother stats of GAMs
renderDataTable({
  map(modonest$modv, ~ summary(.x)$s.table %>% data.frame %>% rownames_to_column('smoother')) %>% 
    enframe %>% 
    unnest%>% 
    mutate_if(is.numeric, round, 2)
}, options = list(pageLength = 10))

# summary stats of GAMs, model fit/perf
renderDataTable({
  map(modonest$modv, ~ data.frame(
      AIC = AIC(.x), 
      GCV = .x$gcv.ubre,
      R2 = summary(.x)$r.sq)) %>% 
    enframe %>% 
    unnest %>% 
    mutate_if(is.numeric, round, 2)
}, options = list(pageLength = 10))
```

```{r, eval = T}
# prediction data
prdplost <- modonest %>%
  mutate(prddat = pmap(list(data, modv), function(data, modv){

    prd <- predict(modv) %>% data.frame(chlprd = .)
    
    out <- data %>% bind_cols(prd)

    return(out)
    
  })) %>% 
  select(modi, prddat) %>% 
  unnest
```

View results for one model at a time:
```{r, echo = F, eval = T}
selectInput('modst', "Select a model:", modonest$modi)
```
```{r, eval = T}
# smoother stats of GAMs
renderTable({
  
  md <- modonest %>% 
    filter(modi %in% input$modst) %>% 
    .$modv %>% 
    .[[1]]
  tab <- summary(md)$s.table %>% data.frame %>% rownames_to_column('smoother')
  return(tab)

})

# summary stats of GAMs, model fit/perf
renderTable({
  
  md <- modonest %>% 
    filter(modi %in% input$modst) %>% 
    .$modv %>% 
    .[[1]] 
  tab <- data.frame(
    AIC = AIC(md), 
    GCV = md$gcv.ubre,
    R2 = summary(md)$r.sq)
  return(tab)
  
})
# predictions across time
renderPlot({
  
  toplo <- prdplost %>% 
    filter(modi %in% input$modst)
  
  # plot
  p <- ggplot(toplo, aes(x = date)) + 
    geom_point(aes(y = log10(chl)), size = 0.5) +
    geom_line(aes(y = chlprd)) + 
    theme_bw(base_family = 'serif', base_size = 16) + 
    theme(
      legend.position = 'top', 
      legend.title = element_blank()
      ) + 
    ggtitle('Station32')
  p
})
# dynagam
renderPlot({
  
  toplo <- modonest %>% 
    filter(modi %in% input$modst)
  
  dynagam(toplo$modv[[1]], toplo$data[[1]], cvr ='sal')
 
}, height = 700, width = 900)

```
