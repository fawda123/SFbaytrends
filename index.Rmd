---
title: "GAM evaluation - SF South Bay"
output: 
  html_document:
    css: kable.css
self_contained: yes
runtime: shiny
---
<a href="https://github.com/fawda123/SFBaytrends/" class="github-corner" aria-label="View source on Github"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#FD6C6C; color:#fff; position: absolute; top: 0; border: 0; left: 0; transform: scale(-1, 1);" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

```{r, message = F, warning = F, results = 'hide', echo = F}
# globals
library(knitr)
opts_chunk$set(warning = FALSE, message = FALSE, dev.args = list(bg = 'transparent'), eval = T, echo = F)

tags$head(includeScript("google-analytics.js"))

library(tidyverse)
library(lubridate)
library(shiny)
library(wqtrends)
# devtools::load_all('../wqtrends')
library(ggmap)
library(mgcv)
library(plotly)
library(gridExtra)
library(shinyWidgets)
source('R/funcs.R')

data(datprc)
data(locs)
data(map)

yrs <- seq(1990, 2020)
params <- list(
  'Chlorophyll-a (ug/L)' = 'chl', 
  'GPP (mg C m-2 d-1)' = 'gpp', 
  'DO (mg/L)' = 'docalc'
)

# ext <- make_bbox(locs$lon, locs$lat, f = 0.2)
# map <- get_stamenmap(ext,  zoom = 11, maptype = "toner-lite", where = getwd())
pbase <- ggmap(map) +
  theme_bw() +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank()
  )
```

```{r reactives}
# selected station location and raw time series
mapselplo <- reactive({

  # inputs
  station <- input$station
  parameter <- input$parameter
  typ <- input$typ
  ylb <- ylb()

  req(ylb)
  
  locpt <- locs %>% 
    filter(Station %in% !!station)
  
  # map
  p1 <- pbase + 
    geom_point(data = locpt, aes(x = lon, y = lat), colour = 'tomato1', size = 8) +
    geom_text(data = locs, aes(x = lon, y = lat, label = Station))

  # time series raw
  toplo <- datprc %>% 
    filter(station %in% !!station) %>% 
    filter(param %in% !!parameter)
  
  if(typ == 'tot')
     p2 <- ggplot(toplo, aes(x = dec_time, y = value)) + 
        geom_line() 
  if(typ == 'yrs')
     p2 <- ggplot(toplo, aes(x = factor(yr), y = value)) + 
        geom_boxplot()
  if(typ == 'mos')
     p2 <- ggplot(toplo, aes(x = mo, y = value)) + 
        geom_boxplot()
      
  # create plots for whole time series, by year, by month
  p2 <- p2 +
    theme_bw() +
    theme(axis.title.x = element_blank())
  
  if(parameter %in% c('gpp', 'chl'))
    p2 <- p2 + 
      scale_y_log10(ylb)
  if(parameter %in% c('docalc'))
    p2 <- p2 + 
      scale_y_continuous(ylb)
  
  out <- grid.arrange(p1, p2, widths = c(0.3, 0.7), ncol = 2)
  
  return(out)
  
})  
  
# models for selected station
mods <- reactive({
  
  # inputs
  parameter <- input$parameter
  station <- input$station
  
  fl <- paste0('mods_', parameter, station)
  load(file = paste0('data/', fl, '.RData'))
  
  out <- get(fl) %>% 
    select(-station, -param, -data, -trans) %>% 
    deframe

  return(out)
  
})

# selected individual model
modsind <- reactive({
  
  # inputs
  mods <- mods()
  mod <- input$mod
  
  out <- mods[mod]
  
  return(out)
  
})

# y axis label
ylb <- reactive({
  
  # input
  parameter <- input$parameter
  
  out <- params %in% parameter %>% which %>% params[.] %>% names
  
  return(out)

})

# text labels for parameter selection
txtlb <- reactive({
  
  # input
  parameter <- input$parameter
  
  out <- params %in% parameter %>% which %>% params[.] %>% names
  out <- gsub('^(.*)\\s.*$', '\\1', out)
  out <- case_when(
    out %in% 'Chlorophyll-a' ~ tolower(out), 
    T ~ out
  )
  
  return(out)
  
})

# smoother stats of GAMs for selected station
modstabsmth <- reactive({
  
  # inputs
  mods <- mods()
  
  out <- anlz_smooth(mods = mods)
  
  return(out)
  
})

# summary stats of GAMs, model fit/perf
modstabfit <- reactive({
  
  # input 
  mods <- mods()
  
  out <- anlz_fit(mods = mods)
  
  return(out)
  
})

# doy plot
prddoy <- reactive({
  
  # inputs
  mods <- mods()
  ylb <- ylb()
  
  out <- show_prddoy(mods = mods, ylab = ylb)
  
  return(out)
  
})

# series plot
prdseries <- reactive({
  
  # inputs
  mods <- mods()
  ylb <- ylb()
  
  out <- show_prdseries(mods = mods, ylab = ylb)
  
  return(out)
  
})

# seasonal predictions
prdseason <- reactive({
  
  # inputs
  mods <- mods()
  ylb <- ylb()
  
  out <- show_prdseason(mods = mods, ylab = ylb)

  return(out)
  
})

# 3d plot
prd3d <- reactive({
  
  # inputs
  modsind <- modsind()
  ylb <- ylb()
  
  out <- show_prd3d(mods = modsind, ylab = ylb)
  
  return(out)
  
})

# smoother stats of selected GAM for selected station
modtabsmth <- reactive({
  
  # input
  mod <- input$mod
  modstabsmth <- modstabsmth()

  out <- modstabsmth %>% 
    filter(model %in% mod) %>% 
    select(-model)
  
  return(out)
  
})

# summary stats of selected GAM for selected station
modtabfit <- reactive({
  
  # input
  mod <- input$mod
  modstabfit <- modstabfit()
  
  out <- modstabfit %>% 
    filter(model %in% mod) %>% 
    select(-model)
  
  return(out)
  
})

# gam check plot for selected GAM for selected station
gamchk <- reactive({
  
  # inputs
  modsind <- modsind()
  
  out <- modsind[[1]] %>% 
    gam.check()
  
  return(out)
  
})

# percent change
perchg <- reactive({
  
  # inputs
  yrbs <- as.numeric(input$yrbs)
  yrts <- as.numeric(input$yrts)
  modsind <- modsind()
  ylb <- ylb()
  
  req(yrbs)
  req(yrts)
  
  out <- show_perchg(mods = modsind, baseyr = yrbs, testyr = yrts, ylab = ylb)
  
  return(out)
  
})

# seasonal averages
avgseason <- reactive({
  
  # inputs
  dytr <- input$dytr
  yrtr <- input$yrtr
  modsind <- modsind()
  ylb <- ylb()
  
  req(yrtr)

  out <- try({show_avgseason(mods = modsind, doystr = dytr[1] , doyend = dytr[2], yrstr = yrtr[1], yrend = yrtr[2], 
                        ylab = ylb)})
  
  validate(
    need(inherits(out, 'ggplot'), 'Pick different year range')
  )
  
  return(out)
  
})

# seasonal trends
trndseason <- reactive({
  
  # inputs
  dytr <- input$dytr
  yrtr <- input$yrtr
  modsind <- modsind()
  wntr <- input$wntr
  wnty <- input$wnty
  
  req(yrtr)
  
  out <- show_trndseason(mods = modsind, doystr = dytr[1] , doyend = dytr[2], win = wntr, justify = wnty, 
                        ylab = 'Change per year')
  
  return(out)
  
})
```

## Exploratory plots

The following plots show the raw data for all monitoring stations and parameters in South Bay, 1990 - 2020.  Select the parameter, plot type (total time series, by year, or by month), and variable transformation.  The year and month plots are aggregated boxplots of all observations at a station for each selected time period.  The variable transformation can be used to show the observations in arithmetic or logarithmic space.

```{r, echo = F}
# selection widgets
column(4, selectInput("station", "Choose station:", sort(unique(datprc$station))))
column(4, selectInput("parameter", "Choose parameter:", choices = params))
```

```{r}
# make the plot
output$mapselplo <- renderPlot(mapselplo(), height = 300, width = 900)
plotOutput('mapselplo')
```

```{r, echo = F}
column(10, NULL)
column(2, selectInput("typ", "Choose plot type:", c('tot', 'yrs', 'mos')))
```

## GAMs of `r renderText(txtlb())` with annual, seasonal trends {.tabset}

Generalized additive models (GAMs) were developed to describe trends in `r renderText(txtlb())` at each of the monitoring stations in South Bay.  The station and selected model can be chosen from the drop down menus.  Four types of GAMs were developed for the time series at each station to model `r renderText(txtlb())` as a function of time, where time is measured as an annual and seasonal effect.  The four models descibe the time components differently and represent increasing levels of complexity to describe the `r renderText(txtlb())` trend:

* `gam0`: `r renderText(input$parameter)` ~ year + s(doy)

* `gam1`: `r renderText(input$parameter)` ~ year + s(doy) + s(year)

* `gam2`: `r renderText(input$parameter)` ~ year + s(doy) + s(year) + ti(doy, year)

* `gam6`: `r renderText(input$parameter)` ~ year + s(doy) + s(year, k = *large*)

For all models, `year` is measured as a continuous numeric variable for the annual effect (e.g., January 1st, 2000 is 2000.0, July 1st, 2000 is 2000.5, etc.) and `doy` is the day of year as a numeric value from 1 to 366.  All models include `year` as a linear effect.  The functions `s()` model either `year` or `doy` as a smoothed, non-linear variable and `ti()` models the interaction between the two.  The fourth model, `gam6`, is the same as `gam1` with the exception that the optimal amount of smoothing on `year` is not constrained by increasing the theoretical upper limit on the number of knots for `k`.  The upper limit of `k` was chosen as 12 times the number of years of data at each station (~300).

### All models

__Select the station with the drop down menu for the summary of all four GAM `r renderText(txtlb())` models.__  

The first table shows the individual effects of the modelled components of each model as the estimated degrees of freedom (`edf`), the reference degrees of freedom (`Ref.df`), the test statistic (`F`), and significance of the component (`p-value`).  The significance of the component is in part based on the difference between `edf` and `Ref.df`.  The second table shows the overall summary of each model as Akaike Information Criterion (`AIC`), the generalized cross-validation score (`GCV`), and the `R2` values.  Lower values for `AIC` and `GCV` and higher values for `R2` indicate improved model fit. The `k` column shows the upper limit for the number of knots on the `year` term, when appropriate (i.e., not gam0). 

The three plots show the predicted trends from each of the four models.  The first plot shows estimated `r renderText(txtlb())` by day of year with separate lines for each year.  The second plot show predictions for the four models across the entire time series. The third plot show the predicted trends with separate lines for each month across the time series.

```{r}
output$modstabsmth <- renderTable(modstabsmth())
output$modstabfit <- renderTable(modstabfit())
tableOutput('modstabsmth')
tableOutput('modstabfit')
```

```{r}
output$prddoy <- renderPlot(prddoy())
plotOutput('prddoy', height = "400px", width = "900px")
```

#### {.tabset .tabset-pills}

##### Continuous

```{r}
output$prdseries <- renderPlot(prdseries())
plotOutput('prdseries', height = "700px")
```

##### By season

```{r}
output$prdseason <- renderPlot(prdseason())
plotOutput('prdseason', height = "800px")
```

### Individual model {.tabset .tabset-pills}

__Selected station:  `r renderText({input$station})`__

The following provides additional information for one of the four models for the selected station.  __Use the drop down menu to select a specific model.__  

The first tab shows a three-dimensional fit of the estimated trends across year and day of year with the z-axis showing estimated `r renderText(txtlb())`.  The second plot shows a table of summary statistics for the selected model (repeated from above) and plot diagnostics of the model fit.  The third tab shows the predicted trends across the time series (and options for trend assessment) and the predicted trends as seasonal aggregations with 95% confidence intervals within each year.

```{r, echo = F}
selectInput('mod', "Select a model:", choices = c('gam0', 'gam1', 'gam2', 'gam6'), selected = 'gam2')
```

#### Fit

```{r}
output$modtabsmth <- renderTable(modtabsmth())
output$modtabfit <- renderTable(modtabfit())
tableOutput('modtabsmth')
tableOutput('modtabfit')
```

```{r}
output$gamchk <- renderPlot(gamchk(), height = 550)
plotOutput('gamchk', height="550px")
```

#### Trends 

```{r}

column(4,
       renderUI({

         req(modsind())
         yrs <- modsind()[[1]]$model %>% pull(dec_time) %>% date_decimal(.) %>% year %>% unique
         pickerInput('yrbs', 'Select base years:', choices = yrs, selected = yrs[c(1,2)], multiple = T)
         
         })
)
column(4,
       renderUI({
         
         req(modsind())
         yrs <- modsind()[[1]]$model %>% pull(dec_time) %>% date_decimal(.) %>% year %>% unique
         pickerInput('yrts', 'Select test years:', choices = yrs, selected = rev(yrs)[c(1,2)], multiple = T)
         
         })
)
```

```{r}
output$perchg <- renderPlot(perchg(), height = 320)
plotOutput('perchg')
```

```{r}
column(12,
  column(6,
    sliderInput('dytr', 'Select day-of-year range to define seasons:', min = 1, max = 365, value = c(213, 304))
  ),
  column(6,
    renderUI({
      
      req(modsind())
      yrs <- modsind()[[1]]$model %>% pull(dec_time) %>% date_decimal(.) %>% year %>% unique
      sliderInput('yrtr', 'Select years for across-year trend estimate:', min = min(yrs), max = max(yrs), value = c(2010, 2020), sep = "", step = 1)
      
    })
  )
)
column(12, 
  column(6, 
    sliderInput('wntr', 'Select window size:', min = 2, max = 20, value = 5)       
  ), 
  column(6, 
    selectInput('wnty', 'Select window type:', choices = c('left', 'center', 'right'))     
  )
)
```

```{r}
output$avgseason <- renderPlot(avgseason(), height = 320)
plotOutput('avgseason')
```

<br></br>
<br></br>
<br></br>


```{r}
output$trndseason <- renderPlot(trndseason(), height = 370)
plotOutput('trndseason')
```

#### 3d

```{r}
output$prd3d <- renderPlotly(prd3d())
plotlyOutput('prd3d')
```
